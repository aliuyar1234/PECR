services:
  postgres:
    image: postgres:16.6-alpine
    environment:
      POSTGRES_USER: pecr
      POSTGRES_PASSWORD: pecr
      POSTGRES_DB: pecr
    ports:
      - "127.0.0.1:${PECR_POSTGRES_PORT:-55432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pecr -d pecr"]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d:ro

  opa:
    image: openpolicyagent/opa:0.66.0
    command:
      [
        "run",
        "--server",
        "--addr=0.0.0.0:8181",
        "--bundle",
        "/bundle",
        "--log-format=json",
      ]
    volumes:
      - ./opa/bundle:/bundle:ro

  gateway:
    build:
      context: .
      dockerfile: docker/gateway.Dockerfile
    environment:
      RUST_LOG: info
      PECR_BIND_ADDR: 0.0.0.0:8080
      PECR_DEV_ALLOW_NONLOCAL_BIND: "${PECR_DEV_ALLOW_NONLOCAL_BIND:-1}"
      PECR_DB_URL: postgres://pecr:pecr@postgres:5432/pecr
      PECR_OPA_URL: "${PECR_OPA_URL:-http://opa:8181}"
      PECR_OPA_TIMEOUT_MS: "${PECR_OPA_TIMEOUT_MS:-200}"
      PECR_POLICY_BUNDLE_HASH: 028f4668cc37ca6270a10726acb8516f308f85bbc4ef106bf9874f436db2d565
      PECR_CACHE_MAX_ENTRIES: "${PECR_CACHE_MAX_ENTRIES:-0}"
      PECR_CACHE_TTL_MS: "${PECR_CACHE_TTL_MS:-0}"
      PECR_PG_SAFEVIEW_QUERY_TIMEOUT_MS: "${PECR_PG_SAFEVIEW_QUERY_TIMEOUT_MS:-200}"
      PECR_EVIDENCE_PAYLOAD_STORE_MODE: metadata-only
      PECR_AUTH_MODE: "${PECR_AUTH_MODE:-local}"
      PECR_FS_CORPUS_PATH: /fixtures/fs_corpus
      PECR_AS_OF_TIME_DEFAULT: "1970-01-01T00:00:00Z"
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "127.0.0.1:8080:8080"
    volumes:
      - ./fixtures:/fixtures:ro

  controller:
    build:
      context: .
      dockerfile: docker/controller.Dockerfile
    environment:
      RUST_LOG: info
      PECR_CONTROLLER_BIND_ADDR: 0.0.0.0:8081
      PECR_DEV_ALLOW_NONLOCAL_BIND: "${PECR_DEV_ALLOW_NONLOCAL_BIND:-1}"
      PECR_GATEWAY_URL: http://gateway:8080
      PECR_MODEL_PROVIDER: mock
      PECR_BUDGET_DEFAULTS: '{"max_operator_calls":10,"max_bytes":1048576,"max_wallclock_ms":10000,"max_recursion_depth":5,"max_parallelism":4}'
      PECR_AUTH_MODE: "${PECR_AUTH_MODE:-local}"
    depends_on:
      gateway:
        condition: service_started
    ports:
      - "127.0.0.1:8081:8081"

  k6:
    image: grafana/k6:0.49.0
    profiles: ["perf"]
    entrypoint: ["k6"]
    volumes:
      - ./scripts/k6:/scripts:ro
      - ./target/perf:/results

  opa_blackhole:
    image: python:3.12.8-alpine
    profiles: ["faults"]
    command:
      [
        "python",
        "-c",
        "import socket,threading,time; s=socket.socket(); s.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1); s.bind(('0.0.0.0',8181)); s.listen(1024);\\n\\ndef hold(conn):\\n  try: time.sleep(3600)\\n  finally: conn.close()\\n\\nwhile True:\\n  c,_=s.accept(); threading.Thread(target=hold,args=(c,),daemon=True).start()",
      ]

volumes:
  postgres_data:
